<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Feeder Analytics | Admin Tools</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    window.supabase = createClient(
      "https://ylkmlkelbpxyqauaqcfk.supabase.co",
      "sb_publishable_72WfxwzjZxDAQmSWVR3_3w_a58rn57e"
    );
  </script>

  <style>
    .fade-rise {
      opacity: 0;
      transform: translateY(12px);
      animation: fadeRise 0.6s ease forwards;
    }

    @keyframes fadeRise {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-slate-900 to-slate-700 min-h-screen text-white p-6">

  <div class="max-w-5xl mx-auto fade-rise">

    <h1 class="text-3xl font-bold mb-6 text-white/90">⚙️ Admin Tools</h1>

    <!-- Tabs -->
    <div class="flex gap-3 mb-6">
      <button id="tabUsers"
        class="px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold">Users</button>

      <button id="tabCampuses"
        class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white font-semibold">
        Campus Assignment
      </button>
    </div>

    <!-- SECTION: USER ACCESS CONTROL -->
    <div id="sectionUsers">
      <div class="bg-white/10 backdrop-blur-xl p-6 rounded-2xl border border-white/20">

        <h2 class="text-xl font-semibold mb-4">User Access Control</h2>

        <!-- Add User -->
        <div class="flex gap-3 mb-4">
          <input id="newUserEmail" type="email" placeholder="Enter STI email..."
            class="flex-1 p-3 rounded-lg bg-white/10 border border-white/20 text-white" />

          <select id="newUserRole"
            class="p-3 rounded-lg bg-white/10 border border-white/20 text-white">
            <option value="viewer">Viewer</option>
            <option value="manager">Manager</option>
            <option value="superadmin">Super Admin</option>
          </select>

          <button id="addUserBtn"
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg">Add</button>
        </div>

        <!-- User Table -->
        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead>
              <tr class="text-slate-300">
                <th class="py-2">Email</th>
                <th class="py-2">Role</th>
                <th class="py-2">Enabled</th>
                <th class="py-2">Last Login</th>
                <th class="py-2">Actions</th>
              </tr>
            </thead>
            <tbody id="userTable" class="text-white"></tbody>
          </table>
        </div>

      </div>
    </div>

    <!-- SECTION: CAMPUS ASSIGNMENT -->
    <div id="sectionCampuses" class="hidden fade-rise">

      <div class="bg-white/10 backdrop-blur-xl p-6 rounded-2xl border border-white/20">

        <h2 class="text-xl font-semibold mb-4">Campus Assignment</h2>

        <!-- User Selector -->
        <div class="mb-4">
          <label class="text-slate-300">Select User</label>
          <select id="assignUserSelector"
            class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white"></select>
        </div>

        <!-- Campus Selection -->
        <div class="mb-4">
          <label class="text-slate-300">Add Campus</label>
          <select id="campusSelector"
            class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white"></select>

          <button id="assignCampusBtn"
            class="mt-3 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg">
            Assign Campus
          </button>
        </div>

        <!-- Assigned Campus List -->
        <div class="bg-white/5 p-4 rounded-xl border border-white/20">
          <h3 class="text-lg mb-3">Assigned Campuses</h3>
          <ul id="assignedCampusList" class="space-y-2"></ul>
        </div>

      </div>
    </div>
  </div>

  <!-- MAIN LOGIC -->
  <script>
    const tabUsers = document.getElementById("tabUsers");
    const tabCampuses = document.getElementById("tabCampuses");
    const sectionUsers = document.getElementById("sectionUsers");
    const sectionCampuses = document.getElementById("sectionCampuses");

    // TAB SWITCHING
    tabUsers.onclick = () => {
      sectionUsers.classList.remove("hidden");
      sectionCampuses.classList.add("hidden");
      tabUsers.classList.add("bg-blue-600");
      tabCampuses.classList.remove("bg-blue-600");
    };

    tabCampuses.onclick = () => {
      sectionUsers.classList.add("hidden");
      sectionCampuses.classList.remove("hidden");
      tabCampuses.classList.add("bg-blue-600");
      tabUsers.classList.remove("bg-blue-600");
    };

    // LOAD USERS IN TABLE
    async function loadUsers() {
      const { data: users } = await supabase
        .from("allowed_users")
        .select("*")
        .order("email");

      const tbody = document.getElementById("userTable");
      tbody.innerHTML = "";

      users?.forEach(u => {
        tbody.innerHTML += `
          <tr class="border-b border-white/10">
            <td class="py-2">${u.email}</td>
            <td class="py-2">${u.role}</td>
            <td class="py-2">${u.enabled ? "✔ Enabled" : "✖ Disabled"}</td>
            <td class="py-2">${u.last_login || "-"}</td>
            <td class="py-2 flex gap-2">
              <button onclick="toggleUser('${u.id}', ${u.enabled})"
                class="px-2 py-1 bg-white/10 rounded">Toggle</button>

              <button onclick="deleteUser('${u.id}')"
                class="px-2 py-1 bg-red-600 rounded">Delete</button>
            </td>
          </tr>
        `;
      });
    }

    // LOAD USERS FOR CAMPUS ASSIGNMENT
    async function loadUsersForCampusAssignment() {
      const { data: users } = await supabase
        .from("allowed_users")
        .select("*")
        .order("email");

      const userSelect = document.getElementById("assignUserSelector");
      userSelect.innerHTML = "";

      users?.forEach(u => {
        userSelect.innerHTML += `<option value="${u.id}">${u.email}</option>`;
      });

      if (users?.length > 0) {
        loadCampusAssignments(users[0].id);
      }
    }

    // LOAD CAMPUS LIST
    async function loadCampusList() {
      const { data } = await supabase
        .from("feeder_schools")
        .select("sti_campus")
        .not("sti_campus", "is", null)
        .order("sti_campus");

      const select = document.getElementById("campusSelector");
      select.innerHTML = "";

      [...new Set(data.map(c => c.sti_campus))].forEach(campus => {
        select.innerHTML += `<option value="${campus}">${campus}</option>`;
      });
    }

    // LOAD ASSIGNED CAMPUSES
    async function loadCampusAssignments(userId) {
      const { data } = await supabase
        .from("user_campuses")
        .select("*")
        .eq("user_id", userId);

      const list = document.getElementById("assignedCampusList");
      list.innerHTML = "";

      data?.forEach(c => {
        list.innerHTML += `
          <li class="flex justify-between bg-white/5 p-2 rounded-lg">
            <span>${c.sti_campus}</span>
            <button onclick="removeCampus('${c.user_id}', '${c.sti_campus}')"
              class="text-red-400 hover:text-red-600">Remove</button>
          </li>
        `;
      });
    }

    // ASSIGN CAMPUS
    document.getElementById("assignCampusBtn").onclick = async () => {
      const userId = document.getElementById("assignUserSelector").value;
      const campus = document.getElementById("campusSelector").value;

      await supabase.from("user_campuses").insert({
        user_id: userId,
        sti_campus: campus
      });

      loadCampusAssignments(userId);
    };

    // REMOVE CAMPUS
    window.removeCampus = async (userId, campus) => {
      await supabase
        .from("user_campuses")
        .delete()
        .eq("user_id", userId)
        .eq("sti_campus", campus);

      loadCampusAssignments(userId);
    };

    // ADD USER
    document.getElementById("addUserBtn").onclick = async () => {
      const email = document.getElementById("newUserEmail").value;
      const role = document.getElementById("newUserRole").value;

      await supabase.from("allowed_users").insert({
        email,
        role,
        enabled: true
      });

      loadUsers();
      loadUsersForCampusAssignment();
    };

    // TOGGLE ENABLE/DISABLE
    window.toggleUser = async (id, enabled) => {
      await supabase
        .from("allowed_users")
        .update({ enabled: !enabled })
        .eq("id", id);

      loadUsers();
    };

    // DELETE USER
    window.deleteUser = async (id) => {
      await supabase.from("allowed_users").delete().eq("id", id);

      loadUsers();
      loadUsersForCampusAssignment();
    };

    // INITIAL LOAD
    loadUsers();
    loadUsersForCampusAssignment();
    loadCampusList();
  </script>

</body>
</html>
