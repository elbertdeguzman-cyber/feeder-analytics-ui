<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Tools | Feeder Analytics</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .fade-rise {
      opacity: 0;
      transform: translateY(15px);
      animation: fadeRise 0.6s ease forwards;
    }
    @keyframes fadeRise {
      to { opacity: 1; transform: translateY(0); }
    }

    #sidebar {
      transition: width .25s ease, padding .25s ease;
    }
    #sidebar.collapsed {
      width: 80px !important;
      padding-left: 0.75rem;
      padding-right: 0.75rem;
    }
    #sidebar.collapsed .nav-label {
      opacity: 0;
      pointer-events: none;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-slate-900 to-slate-700 min-h-screen text-white">

<!-- ========================================================= -->
<!-- SIDEBAR -->
<!-- ========================================================= -->
<aside 
  id="sidebar"
  class="bg-white/10 backdrop-blur-xl border-r border-white/10 w-64 min-h-screen p-6 flex flex-col fixed"
>
  <button id="toggleSidebarBtn"
    class="text-white mb-6 hover:bg-white/10 p-2 rounded-lg transition">
    ‚ò∞
  </button>

  <div class="flex items-center space-x-3 mb-10">
    <img src="assets/images/logo.png" class="h-10 w-auto">
    <span class="text-xl font-bold nav-label">Admin Panel</span>
  </div>

  <nav class="space-y-2">

    <a href="dashboard.html" 
       class="flex items-center space-x-3 text-white/80 hover:bg-white/10 p-3 rounded-lg">
       <span class="text-lg">üè†</span>
       <span class="nav-label">Dashboard</span>
    </a>

    <a href="feeder-review-dashboard.html" 
       class="flex items-center space-x-3 text-white/80 hover:bg-white/10 p-3 rounded-lg">
       <span class="text-lg">üìä</span>
       <span class="nav-label">Feeder Reviews</span>
    </a>

    <!-- Admin Tools Tab -->
    <a href="admin-users.html"
       class="flex items-center space-x-3 bg-blue-600/30 hover:bg-blue-600/40 p-3 rounded-lg">
       <span class="text-lg">‚öôÔ∏è</span>
       <span class="nav-label font-bold">Admin Tools</span>
    </a>

  </nav>
</aside>


<!-- ========================================================= -->
<!-- TOP NAV -->
<!-- ========================================================= -->
<header class="ml-64 bg-white/10 backdrop-blur-xl border-b border-white/10 p-4 flex justify-between items-center shadow-lg fade-rise">
  <h1 class="text-xl font-semibold tracking-wide">Admin Tools</h1>

  <div class="flex items-center gap-3">
    <span id="username" class="text-sm text-slate-300">Loading...</span>
    <img id="userAvatar"
         src="https://ui-avatars.com/api/?name=User"
         class="h-8 w-8 rounded-full border border-white/20">
  </div>
</header>


<!-- ========================================================= -->
<!-- MAIN CONTENT -->
<!-- ========================================================= -->
<main class="ml-64 p-6 fade-rise">

  <!-- Title -->
  <h2 class="text-2xl font-bold mb-6">User Access Control</h2>

  <!-- Add User Panel -->
  <div class="bg-white/10 backdrop-blur-xl border border-white/10 rounded-xl p-6 mb-6">
    <h3 class="text-xl font-semibold mb-3">Add Authorized Email</h3>

    <div class="flex gap-4">
      <input id="newEmail"
             type="email"
             placeholder="user@sti.edu.ph"
             class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white" />

      <button id="addUserBtn"
              class="px-4 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold">
        Add
      </button>
    </div>
  </div>

  <!-- Users Table -->
  <div class="bg-white/10 backdrop-blur-xl border border-white/10 rounded-xl p-6">
    <h3 class="text-xl font-semibold mb-4">Allowed Users</h3>

    <table class="w-full text-left text-sm">
      <thead class="text-slate-300 border-b border-white/10">
        <tr>
          <th class="p-2">Email</th>
          <th class="p-2">Role</th>
          <th class="p-2">Enabled</th>
          <th class="p-2">Last Login</th>
          <th class="p-2 text-right">Actions</th>
        </tr>
      </thead>
      <tbody id="usersTable"></tbody>
    </table>
  </div>

</main>


<!-- ========================================================= -->
<!-- SUPABASE LOGIC -->
<!-- ========================================================= -->
<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://ylkmlkelbpxyqauaqcfk.supabase.co",
  "sb_publishable_72WfxwzjZxDAQmSWVR3_3w_a58rn57e"
);

// -------------------------------
// AUTH CHECK
// -------------------------------
const { data: auth } = await supabase.auth.getUser();
if (!auth?.user) window.location.href = "login.html";

const email = auth.user.email.toLowerCase();

// Load profile
const { data: allowed } = await supabase
  .from("allowed_users")
  .select("*")
  .eq("email", email)
  .maybeSingle();

// Block if not super_admin
if (!allowed || allowed.role !== "super_admin") {
  alert("Access denied. Super Admins only.");
  window.location.href = "dashboard.html";
}

document.getElementById("username").textContent = email;
document.getElementById("userAvatar").src =
  `https://ui-avatars.com/api/?name=${encodeURIComponent(email)}`;


// -------------------------------
// LOAD USERS
// -------------------------------
async function loadUsers() {
  const { data: users } = await supabase
    .from("allowed_users")
    .select("*")
    .order("email");

  const tbody = document.getElementById("usersTable");
  tbody.innerHTML = "";

  users.forEach(u => {
    tbody.innerHTML += `
      <tr class="border-b border-white/10">
        <td class="p-2">${u.email}</td>

        <td class="p-2">
          <select class="bg-white/10 border border-white/20 rounded p-1 text-white"
                  onchange="updateRole('${u.email}', this.value)">
            <option ${u.role === "viewer" ? "selected" : ""}>viewer</option>
            <option ${u.role === "campus_admin" ? "selected" : ""}>campus_admin</option>
            <option ${u.role === "ho" ? "selected" : ""}>ho</option>
            <option ${u.role === "super_admin" ? "selected" : ""}>super_admin</option>
          </select>
        </td>

        <td class="p-2">
          <input type="checkbox"
                 ${u.enabled ? "checked" : ""}
                 onchange="toggleEnabled('${u.email}', this.checked)">
        </td>

        <td class="p-2 text-slate-300">${u.last_login ?? "‚Äî"}</td>

        <td class="p-2 text-right">
          <button onclick="deleteUser('${u.email}')"
                  class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded">
            Delete
          </button>
        </td>
      </tr>
    `;
  });
}

window.updateRole = async (email, role) => {
  await supabase.from("allowed_users")
    .update({ role })
    .eq("email", email);
  loadUsers();
};

window.toggleEnabled = async (email, enabled) => {
  await supabase.from("allowed_users")
    .update({ enabled })
    .eq("email", email);
  loadUsers();
};

window.deleteUser = async (email) => {
  if (!confirm("Delete this user?")) return;
  await supabase.from("allowed_users")
    .delete()
    .eq("email", email);
  loadUsers();
};


// -------------------------------
// ADD NEW USER
// -------------------------------
document.getElementById("addUserBtn").onclick = async () => {
  const newEmail = document.getElementById("newEmail").value.trim().toLowerCase();

  if (!newEmail || !newEmail.endsWith("sti.edu.ph")) {
    alert("Enter a valid STI email.");
    return;
  }

  const { error } = await supabase.from("allowed_users")
    .insert({
      id: crypto.randomUUID(),
      email: newEmail,
      role: "viewer",
      enabled: true
    });

  if (error) alert(error.message);

  document.getElementById("newEmail").value = "";
  loadUsers();
};

loadUsers();
</script>


<!-- ========================================================= -->
<!-- SIDEBAR TOGGLE -->
<!-- ========================================================= -->
<script>
const sidebar = document.getElementById("sidebar");
document.getElementById("toggleSidebarBtn").onclick = () =>
  sidebar.classList.toggle("collapsed");
</script>


</body>
</html>
